id: validate_exec_outputs_isolation 
namespace: sanitychecks
description: |
  Validate that outputs.task_id.output_id from another execution is not accessible directly to other flows in Subflows + Flow triggers
  Originates from : https://github.com/kestra-io/kestra/issues/7653

labels:
  dependencies: "core.flow.Subflow, core.http.Request, core.debug.Return"

tasks:
  - id: make_output
    type: io.kestra.plugin.core.debug.Return
    format: Some value that shouldn't be accesible to other exec.

  - id: create_subflow_yaml
    type: io.kestra.plugin.core.http.Request
    uri: http://localhost:8080/api/v1/flows
    contentType: application/x-yaml
    method: POST
    body: |
      id: validate_exec_outputs_isolation_tool
      namespace: reproducers
      tasks:
        - id: make_sub_output
          type: io.kestra.plugin.core.debug.Return
          format: Some SUB value that shouldn't be accesible to other exec.
        - id: try_access_ouptut
          type: io.kestra.plugin.core.debug.Return
          format: |
            {% raw %}{{ outputs.make_output.value }}{% endraw %}
      outputs:
        - id: value
          type: STRING
          value: |
            {% raw %}{{ outputs.try_access_ouptut.value ?? 'empty' }}{% endraw %}

  - id: call_sublfow
    type: io.kestra.plugin.core.flow.Subflow
    flowId: validate_exec_outputs_isolation_tool
    namespace: reproducers
    inheritLabels: true
    transmitFailed: false

  - id: assert_fail_and_unreachable_sub_output
    type: io.kestra.plugin.core.execution.Assert
    conditions:
      - |
        {{ outputs.call_sublfow.outputs.value == 'empty' }}
      - |
        {{ outputs.make_sub_ouput.value ?? 'empty' == 'empty' }}
        
finally:
  - id: remove_subflow_artifact
    type: io.kestra.plugin.core.http.Request
    uri: http://localhost:8080/api/v1/flows/reproducers/validate_exec_outputs_isolation_tool
    method: DELETE
