id: purge-disk-space
namespace: blueprints
description: "This flow may be triggered to clean the storage of this Kestra instance within a selected period while targeting specific item types."

labels:
  type: KESTRA_MANAGEMENT_TOOL

inputs:
  - id: start
    type: DATETIME
    required: true

  - id: end
    type: DATETIME
    required: true

  - id: what_to_purge
    type: MULTISELECT
    values:
      - LOGS
      - EXECUTIONS
      - METRICS
      - STORAGE

  - id: allow_destructive_action
    type: STRING
    description: "BE CAREFUL! This is a highly destructive action. Type 'ALLOW' if you're sure you want to proceed with the deletion."
    dependsOn:
      inputs:
        - start
        - end
        - what_to_purge
      condition: "{{ inputs.start is not empty and inputs.end is not empty and inputs.what_to_purge is not empty}}"
    required: true
    validator: ^ALLOW$

tasks:
  - id: logs_cleaning
    type: io.kestra.plugin.core.log.PurgeLogs
    runIf: "{{ inputs.what_to_purge contains 'LOGS' }}"
    startDate: "{{ inputs.start }}"
    endDate: "{{ inputs.end }}"

  - id: logs_bis_cleaning
    type: io.kestra.plugin.core.execution.PurgeExecutions
    purgeExecution: false
    purgeMetric: false
    purgeStorage: false
    purgeLog: true
    runIf: "{{ inputs.what_to_purge contains 'LOGS' }}"

  - id: storage_cleaning
    type: io.kestra.plugin.core.execution.PurgeExecutions
    purgeExecution: false
    purgeMetric: false
    purgeStorage: true
    purgeLog: false
    runIf: "{{ inputs.what_to_purge contains 'STORAGE' }}"

  - id: metrics_cleaning
    type: io.kestra.plugin.core.execution.PurgeExecutions
    purgeExecution: false
    purgeMetric: true
    purgeStorage: false
    purgeLog: false
    runIf: "{{ inputs.what_to_purge contains 'METRICS' }}"

  - id: executions_cleaning
    type: io.kestra.plugin.core.execution.PurgeExecutions
    purgeExecution: true
    purgeMetric: false
    purgeStorage: false
    purgeLog: false
    runIf: "{{ inputs.what_to_purge contains 'EXECUTIONS' }}"

pluginDefaults:
  - type: io.kestra.plugin.core.execution.PurgeExecutions
    values:
      startDate: "{{ inputs.start }}"
      endDate: "{{ inputs.end }}"

extend:
  title: Free up disk space by purging logs, executions, and metrics based on a time range
  description: >-
    This flow helps manage storage by purging outdated logs, executions, metrics, and stored files 
    based on a user-defined time range. It's useful for administrators who need to reclaim disk space 
    while maintaining control over which type of data is deleted.

    - Users specify a start and end date, as well as the types of data to purge (logs, executions, metrics, or storage).
    - The flow contains multiple purge tasks, each targeting a specific type of data.
    - A safeguard is in place requiring users to confirm destructive actions by typing "ALLOW."
    - Purged data cannot be recovered, so it is recommended to use this flow with caution.
  tags:
    - System
    - API
  ee: false
  demo: false
  meta_description: This flow purges outdated logs, executions, and stored files in Kestra based on a time range.
